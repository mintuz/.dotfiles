Object.defineProperty(exports, '__esModule', {
  value: true
});

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

exports.activate = activate;
exports.deactivate = deactivate;
exports.consumeToolBar = consumeToolBar;
exports.consumeGadgetsService = consumeGadgetsService;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) arr2[i] = arr[i]; return arr2; } else { return Array.from(arr); } }

// Imports from non-Nuclide modules.

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

var _atom = require('atom');

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _rx = require('rx');

var _rx2 = _interopRequireDefault(_rx);

// Imports from other Nuclide packages.

var _analytics = require('../../analytics');

var _atomHelpers = require('../../atom-helpers');

var _featureConfig = require('../../feature-config');

var _featureConfig2 = _interopRequireDefault(_featureConfig);

// Imports from within this Nuclide package.

var _createHealthGadget = require('./createHealthGadget');

var _createHealthGadget2 = _interopRequireDefault(_createHealthGadget);

// We may as well declare these outside of Activation because most of them really are nullable.
var currentConfig = {};
var paneItem = undefined;
var viewTimeout = null;
var analyticsTimeout = null;
var analyticsBuffer = [];
var gadgets = null;

// Variables for tracking where and when a key was pressed, and the time before it had an effect.
var activeEditorSubscriptions = null;
var keyEditorId = 0;
var keyDownTime = 0;
var keyLatency = 0;
var lastKeyLatency = 0;

var paneItemState$ = null;

var subscriptions = null;

function activate(state) {
  paneItemState$ = new _rx2['default'].BehaviorSubject(null);
  subscriptions = new _atom.CompositeDisposable();
  subscriptions.add(_featureConfig2['default'].onDidChange('nuclide-health', function (event) {
    currentConfig = event.newValue;
    // If user changes any config, update the health - and reset the polling cycles.
    updateViews();
    updateAnalytics();
  }), atom.workspace.onDidChangeActivePaneItem(disposeActiveEditorDisposables), _atomHelpers.atomEventDebounce.onWorkspaceDidStopChangingActivePaneItem(timeActiveEditorKeys));
  currentConfig = _featureConfig2['default'].get('nuclide-health');
  timeActiveEditorKeys();
  updateViews();
  updateAnalytics();
}

function deactivate() {
  subscriptions.dispose();
  paneItemState$ = null;
  if (viewTimeout !== null) {
    clearTimeout(viewTimeout);
    viewTimeout = null;
  }
  if (analyticsTimeout !== null) {
    clearTimeout(analyticsTimeout);
    analyticsTimeout = null;
  }
  if (activeEditorSubscriptions) {
    activeEditorSubscriptions.dispose();
    activeEditorSubscriptions = null;
  }
}

function consumeToolBar(getToolBar) {
  var toolBar = getToolBar('nuclide-health');
  toolBar.addButton({
    icon: 'dashboard',
    callback: 'nuclide-health:toggle',
    tooltip: 'Toggle Nuclide health stats',
    priority: 900
  });
  subscriptions.add(new _atom.Disposable(function () {
    toolBar.removeItems();
  }));
}

function consumeGadgetsService(gadgetsApi) {
  (0, _assert2['default'])(paneItemState$);
  gadgets = gadgetsApi;
  var gadget = (0, _createHealthGadget2['default'])(paneItemState$);
  return gadgetsApi.registerGadget(gadget);
}

function disposeActiveEditorDisposables() {
  // Clear out any events & timing data from previous text editor.
  if (activeEditorSubscriptions != null) {
    activeEditorSubscriptions.dispose();
    activeEditorSubscriptions = null;
  }
}

function timeActiveEditorKeys() {
  disposeActiveEditorDisposables();
  activeEditorSubscriptions = new _atom.CompositeDisposable();

  // If option is enabled, start timing latency of keys on the new text editor.
  if (!paneItem) {
    return;
  }

  // Ensure the editor is valid and there is a view to attatch the keypress timing to.
  var editor = atom.workspace.getActiveTextEditor();
  if (!editor) {
    return;
  }
  var view = atom.views.getView(editor);
  if (!view) {
    return;
  }

  // Start the clock when a key is pressed. Function is named so it can be disposed well.
  var startKeyClock = function startKeyClock() {
    if (editor) {
      keyEditorId = editor.id;
      keyDownTime = Date.now();
    }
  };

  // Stop the clock when the (same) editor has changed content.
  var stopKeyClock = function stopKeyClock() {
    if (editor && editor.id && keyEditorId === editor.id && keyDownTime) {
      keyLatency = Date.now() - keyDownTime;
      // Reset so that subsequent non-key-initiated buffer updates don't produce silly big numbers.
      keyDownTime = 0;
    }
  };

  // Add the listener to keydown.
  view.addEventListener('keydown', startKeyClock);

  activeEditorSubscriptions.add(
  // Remove the listener in a home-made disposable for when this editor is no-longer active.
  new _atom.Disposable(function () {
    return view.removeEventListener('keydown', startKeyClock);
  }),

  // stopKeyClock is fast so attatching it to onDidChange here is OK.
  // onDidStopChanging would be another option - any cost is deferred, but with far less fidelity.
  editor.onDidChange(stopKeyClock));
}

function updateViews() {
  if (!paneItemState$) {
    return;
  }

  var stats = getHealthStats();
  analyticsBuffer.push(stats);
  paneItemState$.onNext({ stats: stats, activeHandleObjects: getActiveHandles() });
  if (currentConfig.viewTimeout) {
    if (viewTimeout !== null) {
      clearTimeout(viewTimeout);
    }
    viewTimeout = setTimeout(updateViews, currentConfig.viewTimeout * 1000);
  }
}

function updateAnalytics() {
  if (analyticsBuffer.length > 0) {
    (function () {
      // Aggregates the buffered stats up by suffixing avg, min, max to their names.
      var aggregateStats = {};

      // All analyticsBuffer entries have the same keys; we use the first entry to know what they are.
      Object.keys(analyticsBuffer[0]).forEach(function (statsKey) {
        if (statsKey === 'lastKeyLatency') {
          return;
          // This field is only used to for a sticky value in the status bar, and is not to be sent.
        }

        var aggregates = aggregate(analyticsBuffer.map(function (stats) {
          return stats[statsKey];
        }), statsKey === 'keyLatency');
        // skipZeros: Don't use empty key latency values in aggregates.
        Object.keys(aggregates).forEach(function (aggregatesKey) {
          var value = aggregates[aggregatesKey];
          if (value !== null && value !== undefined) {
            aggregateStats[statsKey + '_' + aggregatesKey] = value.toFixed(2);
          }
        });
      });
      (0, _analytics.track)('nuclide-health', aggregateStats);
      analyticsBuffer = [];
    })();
  }

  if (currentConfig.analyticsTimeout) {
    if (analyticsTimeout !== null) {
      clearTimeout(analyticsTimeout);
    }
    analyticsTimeout = setTimeout(updateAnalytics, currentConfig.analyticsTimeout * 60 * 1000);
  }
}

function aggregate(values) {
  var skipZeros = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];

  // Some values (like memory usage) might be very high & numerous, so avoid summing them all up.
  if (skipZeros) {
    values = values.filter(function (value) {
      return value !== 0;
    });
    if (values.length === 0) {
      return { avg: null, min: null, max: null };
    }
  }
  var avg = values.reduce(function (prevValue, currValue, index) {
    return prevValue + (currValue - prevValue) / (index + 1);
  }, 0);
  var min = Math.min.apply(Math, _toConsumableArray(values));
  var max = Math.max.apply(Math, _toConsumableArray(values));
  return { avg: avg, min: min, max: max };
}

function getHealthStats() {
  var stats = process.memoryUsage(); // RSS, heap and usage.

  if (keyLatency) {
    lastKeyLatency = keyLatency;
  }

  var result = _extends({}, stats, {
    heapPercentage: 100 * stats.heapUsed / stats.heapTotal, // Just for convenience.
    cpuPercentage: _os2['default'].loadavg()[0], // 1 minute CPU average.
    lastKeyLatency: lastKeyLatency,
    keyLatency: keyLatency,
    activeHandles: getActiveHandles().length,
    activeRequests: getActiveRequests().length
  });

  keyLatency = 0; // We only want to ever record a key latency time once, and so we reset it.

  return result;
}

// These two functions are to defend against undocumented Node functions.
function getActiveHandles() {
  if (process._getActiveHandles) {
    return process._getActiveHandles();
  }
  return [];
}

function getActiveRequests() {
  if (process._getActiveRequests) {
    return process._getActiveRequests();
  }
  return [];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkhlYWx0aFBhY2thZ2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztzQkFlc0IsUUFBUTs7OztvQkFDZ0IsTUFBTTs7a0JBQ3JDLElBQUk7Ozs7a0JBQ0osSUFBSTs7Ozs7O3lCQUdDLGlCQUFpQjs7MkJBQ0wsb0JBQW9COzs2QkFDMUIsc0JBQXNCOzs7Ozs7a0NBR2pCLHNCQUFzQjs7Ozs7QUFHckQsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDO0FBQ3ZCLElBQUksUUFBc0IsWUFBQSxDQUFDO0FBQzNCLElBQUksV0FBb0IsR0FBRyxJQUFJLENBQUM7QUFDaEMsSUFBSSxnQkFBeUIsR0FBRyxJQUFJLENBQUM7QUFDckMsSUFBSSxlQUFtQyxHQUFHLEVBQUUsQ0FBQztBQUM3QyxJQUFJLE9BQXdCLEdBQUcsSUFBSSxDQUFDOzs7QUFHcEMsSUFBSSx5QkFBK0MsR0FBRyxJQUFJLENBQUM7QUFDM0QsSUFBSSxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQ3BCLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQztBQUNwQixJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUM7QUFDbkIsSUFBSSxjQUFjLEdBQUcsQ0FBQyxDQUFDOztBQUV2QixJQUFJLGNBQW1DLEdBQUcsSUFBSSxDQUFDOztBQUUvQyxJQUFJLGFBQWtDLEdBQUksSUFBSSxBQUFNLENBQUM7O0FBRTlDLFNBQVMsUUFBUSxDQUFDLEtBQWMsRUFBRTtBQUN2QyxnQkFBYyxHQUFHLElBQUksZ0JBQUcsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzlDLGVBQWEsR0FBRywrQkFBeUIsQ0FBQztBQUMxQyxlQUFhLENBQUMsR0FBRyxDQUNmLDJCQUFjLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxVQUFDLEtBQUssRUFBSztBQUNyRCxpQkFBYSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUM7O0FBRS9CLGVBQVcsRUFBRSxDQUFDO0FBQ2QsbUJBQWUsRUFBRSxDQUFDO0dBQ25CLENBQUMsRUFDRixJQUFJLENBQUMsU0FBUyxDQUFDLHlCQUF5QixDQUFDLDhCQUE4QixDQUFDLEVBQ3hFLCtCQUFrQix3Q0FBd0MsQ0FBQyxvQkFBb0IsQ0FBQyxDQUNqRixDQUFDO0FBQ0YsZUFBYSxHQUFHLDJCQUFjLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQ3BELHNCQUFvQixFQUFFLENBQUM7QUFDdkIsYUFBVyxFQUFFLENBQUM7QUFDZCxpQkFBZSxFQUFFLENBQUM7Q0FDbkI7O0FBRU0sU0FBUyxVQUFVLEdBQUc7QUFDM0IsZUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3hCLGdCQUFjLEdBQUcsSUFBSSxDQUFDO0FBQ3RCLE1BQUksV0FBVyxLQUFLLElBQUksRUFBRTtBQUN4QixnQkFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQzFCLGVBQVcsR0FBRyxJQUFJLENBQUM7R0FDcEI7QUFDRCxNQUFJLGdCQUFnQixLQUFLLElBQUksRUFBRTtBQUM3QixnQkFBWSxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDL0Isb0JBQWdCLEdBQUcsSUFBSSxDQUFDO0dBQ3pCO0FBQ0QsTUFBSSx5QkFBeUIsRUFBRTtBQUM3Qiw2QkFBeUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNwQyw2QkFBeUIsR0FBRyxJQUFJLENBQUM7R0FDbEM7Q0FDRjs7QUFFTSxTQUFTLGNBQWMsQ0FBQyxVQUFxQyxFQUFRO0FBQzFFLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQzdDLFNBQU8sQ0FBQyxTQUFTLENBQUM7QUFDaEIsUUFBSSxFQUFFLFdBQVc7QUFDakIsWUFBUSxFQUFFLHVCQUF1QjtBQUNqQyxXQUFPLEVBQUUsNkJBQTZCO0FBQ3RDLFlBQVEsRUFBRSxHQUFHO0dBQ2QsQ0FBQyxDQUFDO0FBQ0gsZUFBYSxDQUFDLEdBQUcsQ0FBQyxxQkFBZSxZQUFNO0FBQ3JDLFdBQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztHQUN2QixDQUFDLENBQUMsQ0FBQztDQUNMOztBQUVNLFNBQVMscUJBQXFCLENBQUMsVUFBMEIsRUFBYztBQUM1RSwyQkFBVSxjQUFjLENBQUMsQ0FBQztBQUMxQixTQUFPLEdBQUcsVUFBVSxDQUFDO0FBQ3JCLE1BQU0sTUFBYyxHQUFJLHFDQUFtQixjQUFjLENBQUMsQUFBTSxDQUFDO0FBQ2pFLFNBQU8sVUFBVSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztDQUMxQzs7QUFFRCxTQUFTLDhCQUE4QixHQUFTOztBQUU5QyxNQUFJLHlCQUF5QixJQUFJLElBQUksRUFBRTtBQUNyQyw2QkFBeUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNwQyw2QkFBeUIsR0FBRyxJQUFJLENBQUM7R0FDbEM7Q0FDRjs7QUFFRCxTQUFTLG9CQUFvQixHQUFTO0FBQ3BDLGdDQUE4QixFQUFFLENBQUM7QUFDakMsMkJBQXlCLEdBQUcsK0JBQXlCLENBQUM7OztBQUd0RCxNQUFJLENBQUMsUUFBUSxFQUFFO0FBQ2IsV0FBTztHQUNSOzs7QUFHRCxNQUFNLE1BQW1CLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0FBQ2pFLE1BQUksQ0FBQyxNQUFNLEVBQUU7QUFDWCxXQUFPO0dBQ1I7QUFDRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN4QyxNQUFJLENBQUMsSUFBSSxFQUFFO0FBQ1QsV0FBTztHQUNSOzs7QUFHRCxNQUFNLGFBQWEsR0FBRyxTQUFoQixhQUFhLEdBQVM7QUFDMUIsUUFBSSxNQUFNLEVBQUU7QUFDVixpQkFBVyxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUM7QUFDeEIsaUJBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7S0FDMUI7R0FDRixDQUFDOzs7QUFHRixNQUFNLFlBQVksR0FBRyxTQUFmLFlBQVksR0FBUztBQUN6QixRQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsRUFBRSxJQUFJLFdBQVcsS0FBSyxNQUFNLENBQUMsRUFBRSxJQUFJLFdBQVcsRUFBRTtBQUNuRSxnQkFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxXQUFXLENBQUM7O0FBRXRDLGlCQUFXLEdBQUcsQ0FBQyxDQUFDO0tBQ2pCO0dBQ0YsQ0FBQzs7O0FBR0YsTUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQzs7QUFFaEQsMkJBQXlCLENBQUMsR0FBRzs7QUFFM0IsdUJBQWU7V0FBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLGFBQWEsQ0FBQztHQUFBLENBQUM7Ozs7QUFJeEUsUUFBTSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FDakMsQ0FBQztDQUNIOztBQUVELFNBQVMsV0FBVyxHQUFTO0FBQzNCLE1BQUksQ0FBQyxjQUFjLEVBQUU7QUFDbkIsV0FBTztHQUNSOztBQUVELE1BQU0sS0FBSyxHQUFHLGNBQWMsRUFBRSxDQUFDO0FBQy9CLGlCQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzVCLGdCQUFjLENBQUMsTUFBTSxDQUFDLEVBQUMsS0FBSyxFQUFMLEtBQUssRUFBRSxtQkFBbUIsRUFBRSxnQkFBZ0IsRUFBRSxFQUFDLENBQUMsQ0FBQztBQUN4RSxNQUFJLGFBQWEsQ0FBQyxXQUFXLEVBQUU7QUFDN0IsUUFBSSxXQUFXLEtBQUssSUFBSSxFQUFFO0FBQ3hCLGtCQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7S0FDM0I7QUFDRCxlQUFXLEdBQUcsVUFBVSxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxDQUFDO0dBQ3pFO0NBQ0Y7O0FBRUQsU0FBUyxlQUFlLEdBQVM7QUFDL0IsTUFBSSxlQUFlLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTs7O0FBRTlCLFVBQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQzs7O0FBRzFCLFlBQU0sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsUUFBUSxFQUFJO0FBQ2xELFlBQUksUUFBUSxLQUFLLGdCQUFnQixFQUFFO0FBQ2pDLGlCQUFPOztTQUVSOztBQUVELFlBQU0sVUFBVSxHQUFHLFNBQVMsQ0FDMUIsZUFBZSxDQUFDLEdBQUcsQ0FBQyxVQUFBLEtBQUs7aUJBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQztTQUFBLENBQUMsRUFDNUMsUUFBUSxLQUFLLFlBQVksQ0FDM0IsQ0FBQzs7QUFDRixjQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLGFBQWEsRUFBSTtBQUMvQyxjQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDeEMsY0FBSSxLQUFLLEtBQUssSUFBSSxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7QUFDekMsMEJBQWMsQ0FBSSxRQUFRLFNBQUksYUFBYSxDQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztXQUNuRTtTQUNGLENBQUMsQ0FBQztPQUNKLENBQUMsQ0FBQztBQUNILDRCQUFNLGdCQUFnQixFQUFFLGNBQWMsQ0FBQyxDQUFDO0FBQ3hDLHFCQUFlLEdBQUcsRUFBRSxDQUFDOztHQUN0Qjs7QUFFRCxNQUFJLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRTtBQUNsQyxRQUFJLGdCQUFnQixLQUFLLElBQUksRUFBRTtBQUM3QixrQkFBWSxDQUFDLGdCQUFnQixDQUFDLENBQUM7S0FDaEM7QUFDRCxvQkFBZ0IsR0FBRyxVQUFVLENBQUMsZUFBZSxFQUFFLGFBQWEsQ0FBQyxnQkFBZ0IsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7R0FDNUY7Q0FDRjs7QUFFRCxTQUFTLFNBQVMsQ0FDaEIsTUFBcUIsRUFFdUI7TUFENUMsU0FBa0IseURBQUcsS0FBSzs7O0FBRzFCLE1BQUksU0FBUyxFQUFFO0FBQ2IsVUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBQSxLQUFLO2FBQUksS0FBSyxLQUFLLENBQUM7S0FBQSxDQUFDLENBQUM7QUFDN0MsUUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtBQUN2QixhQUFPLEVBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUMsQ0FBQztLQUMxQztHQUNGO0FBQ0QsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFLO0FBQ3pELFdBQU8sU0FBUyxHQUFHLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQSxJQUFLLEtBQUssR0FBRyxDQUFDLENBQUEsQUFBQyxDQUFDO0dBQzFELEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDTixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxNQUFBLENBQVIsSUFBSSxxQkFBUSxNQUFNLEVBQUMsQ0FBQztBQUNoQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxNQUFBLENBQVIsSUFBSSxxQkFBUSxNQUFNLEVBQUMsQ0FBQztBQUNoQyxTQUFPLEVBQUMsR0FBRyxFQUFILEdBQUcsRUFBRSxHQUFHLEVBQUgsR0FBRyxFQUFFLEdBQUcsRUFBSCxHQUFHLEVBQUMsQ0FBQztDQUN4Qjs7QUFFRCxTQUFTLGNBQWMsR0FBZ0I7QUFDckMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDOztBQUVwQyxNQUFJLFVBQVUsRUFBRTtBQUNkLGtCQUFjLEdBQUcsVUFBVSxDQUFDO0dBQzdCOztBQUVELE1BQU0sTUFBTSxnQkFDUCxLQUFLO0FBQ1Isa0JBQWMsRUFBRyxHQUFHLEdBQUcsS0FBSyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsU0FBUyxBQUFDO0FBQ3hELGlCQUFhLEVBQUUsZ0JBQUcsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzlCLGtCQUFjLEVBQWQsY0FBYztBQUNkLGNBQVUsRUFBVixVQUFVO0FBQ1YsaUJBQWEsRUFBRSxnQkFBZ0IsRUFBRSxDQUFDLE1BQU07QUFDeEMsa0JBQWMsRUFBRSxpQkFBaUIsRUFBRSxDQUFDLE1BQU07SUFDM0MsQ0FBQzs7QUFFRixZQUFVLEdBQUcsQ0FBQyxDQUFDOztBQUVmLFNBQU8sTUFBTSxDQUFDO0NBQ2Y7OztBQUdELFNBQVMsZ0JBQWdCLEdBQWtCO0FBQ3pDLE1BQUksT0FBTyxDQUFDLGlCQUFpQixFQUFFO0FBQzdCLFdBQU8sT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUM7R0FDcEM7QUFDRCxTQUFPLEVBQUUsQ0FBQztDQUNYOztBQUVELFNBQVMsaUJBQWlCLEdBQWtCO0FBQzFDLE1BQUksT0FBTyxDQUFDLGtCQUFrQixFQUFFO0FBQzlCLFdBQU8sT0FBTyxDQUFDLGtCQUFrQixFQUFFLENBQUM7R0FDckM7QUFDRCxTQUFPLEVBQUUsQ0FBQztDQUNYIiwiZmlsZSI6IkhlYWx0aFBhY2thZ2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7R2FkZ2V0c1NlcnZpY2UsIEdhZGdldH0gZnJvbSAnLi4vLi4vZ2FkZ2V0cy1pbnRlcmZhY2VzJztcbmltcG9ydCB0eXBlIHtIZWFsdGhTdGF0c30gZnJvbSAnLi90eXBlcyc7XG5cbi8vIEltcG9ydHMgZnJvbSBub24tTnVjbGlkZSBtb2R1bGVzLlxuaW1wb3J0IGludmFyaWFudCBmcm9tICdhc3NlcnQnO1xuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlLCBEaXNwb3NhYmxlfSBmcm9tICdhdG9tJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgUnggZnJvbSAncngnO1xuXG4vLyBJbXBvcnRzIGZyb20gb3RoZXIgTnVjbGlkZSBwYWNrYWdlcy5cbmltcG9ydCB7dHJhY2t9IGZyb20gJy4uLy4uL2FuYWx5dGljcyc7XG5pbXBvcnQge2F0b21FdmVudERlYm91bmNlfSBmcm9tICcuLi8uLi9hdG9tLWhlbHBlcnMnO1xuaW1wb3J0IGZlYXR1cmVDb25maWcgZnJvbSAnLi4vLi4vZmVhdHVyZS1jb25maWcnO1xuXG4vLyBJbXBvcnRzIGZyb20gd2l0aGluIHRoaXMgTnVjbGlkZSBwYWNrYWdlLlxuaW1wb3J0IGNyZWF0ZUhlYWx0aEdhZGdldCBmcm9tICcuL2NyZWF0ZUhlYWx0aEdhZGdldCc7XG5cbi8vIFdlIG1heSBhcyB3ZWxsIGRlY2xhcmUgdGhlc2Ugb3V0c2lkZSBvZiBBY3RpdmF0aW9uIGJlY2F1c2UgbW9zdCBvZiB0aGVtIHJlYWxseSBhcmUgbnVsbGFibGUuXG5sZXQgY3VycmVudENvbmZpZyA9IHt9O1xubGV0IHBhbmVJdGVtOiA/SFRNTEVsZW1lbnQ7XG5sZXQgdmlld1RpbWVvdXQ6ID9udW1iZXIgPSBudWxsO1xubGV0IGFuYWx5dGljc1RpbWVvdXQ6ID9udW1iZXIgPSBudWxsO1xubGV0IGFuYWx5dGljc0J1ZmZlcjogQXJyYXk8SGVhbHRoU3RhdHM+ID0gW107XG5sZXQgZ2FkZ2V0czogP0dhZGdldHNTZXJ2aWNlID0gbnVsbDtcblxuLy8gVmFyaWFibGVzIGZvciB0cmFja2luZyB3aGVyZSBhbmQgd2hlbiBhIGtleSB3YXMgcHJlc3NlZCwgYW5kIHRoZSB0aW1lIGJlZm9yZSBpdCBoYWQgYW4gZWZmZWN0LlxubGV0IGFjdGl2ZUVkaXRvclN1YnNjcmlwdGlvbnM6ID9Db21wb3NpdGVEaXNwb3NhYmxlID0gbnVsbDtcbmxldCBrZXlFZGl0b3JJZCA9IDA7XG5sZXQga2V5RG93blRpbWUgPSAwO1xubGV0IGtleUxhdGVuY3kgPSAwO1xubGV0IGxhc3RLZXlMYXRlbmN5ID0gMDtcblxubGV0IHBhbmVJdGVtU3RhdGUkOiA/UnguQmVoYXZpb3JTdWJqZWN0ID0gbnVsbDtcblxubGV0IHN1YnNjcmlwdGlvbnM6IENvbXBvc2l0ZURpc3Bvc2FibGUgPSAobnVsbDogYW55KTtcblxuZXhwb3J0IGZ1bmN0aW9uIGFjdGl2YXRlKHN0YXRlOiA/T2JqZWN0KSB7XG4gIHBhbmVJdGVtU3RhdGUkID0gbmV3IFJ4LkJlaGF2aW9yU3ViamVjdChudWxsKTtcbiAgc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gIHN1YnNjcmlwdGlvbnMuYWRkKFxuICAgIGZlYXR1cmVDb25maWcub25EaWRDaGFuZ2UoJ251Y2xpZGUtaGVhbHRoJywgKGV2ZW50KSA9PiB7XG4gICAgICBjdXJyZW50Q29uZmlnID0gZXZlbnQubmV3VmFsdWU7XG4gICAgICAvLyBJZiB1c2VyIGNoYW5nZXMgYW55IGNvbmZpZywgdXBkYXRlIHRoZSBoZWFsdGggLSBhbmQgcmVzZXQgdGhlIHBvbGxpbmcgY3ljbGVzLlxuICAgICAgdXBkYXRlVmlld3MoKTtcbiAgICAgIHVwZGF0ZUFuYWx5dGljcygpO1xuICAgIH0pLFxuICAgIGF0b20ud29ya3NwYWNlLm9uRGlkQ2hhbmdlQWN0aXZlUGFuZUl0ZW0oZGlzcG9zZUFjdGl2ZUVkaXRvckRpc3Bvc2FibGVzKSxcbiAgICBhdG9tRXZlbnREZWJvdW5jZS5vbldvcmtzcGFjZURpZFN0b3BDaGFuZ2luZ0FjdGl2ZVBhbmVJdGVtKHRpbWVBY3RpdmVFZGl0b3JLZXlzKSxcbiAgKTtcbiAgY3VycmVudENvbmZpZyA9IGZlYXR1cmVDb25maWcuZ2V0KCdudWNsaWRlLWhlYWx0aCcpO1xuICB0aW1lQWN0aXZlRWRpdG9yS2V5cygpO1xuICB1cGRhdGVWaWV3cygpO1xuICB1cGRhdGVBbmFseXRpY3MoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYWN0aXZhdGUoKSB7XG4gIHN1YnNjcmlwdGlvbnMuZGlzcG9zZSgpO1xuICBwYW5lSXRlbVN0YXRlJCA9IG51bGw7XG4gIGlmICh2aWV3VGltZW91dCAhPT0gbnVsbCkge1xuICAgIGNsZWFyVGltZW91dCh2aWV3VGltZW91dCk7XG4gICAgdmlld1RpbWVvdXQgPSBudWxsO1xuICB9XG4gIGlmIChhbmFseXRpY3NUaW1lb3V0ICE9PSBudWxsKSB7XG4gICAgY2xlYXJUaW1lb3V0KGFuYWx5dGljc1RpbWVvdXQpO1xuICAgIGFuYWx5dGljc1RpbWVvdXQgPSBudWxsO1xuICB9XG4gIGlmIChhY3RpdmVFZGl0b3JTdWJzY3JpcHRpb25zKSB7XG4gICAgYWN0aXZlRWRpdG9yU3Vic2NyaXB0aW9ucy5kaXNwb3NlKCk7XG4gICAgYWN0aXZlRWRpdG9yU3Vic2NyaXB0aW9ucyA9IG51bGw7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnN1bWVUb29sQmFyKGdldFRvb2xCYXI6IChncm91cDogc3RyaW5nKSA9PiBPYmplY3QpOiB2b2lkIHtcbiAgY29uc3QgdG9vbEJhciA9IGdldFRvb2xCYXIoJ251Y2xpZGUtaGVhbHRoJyk7XG4gIHRvb2xCYXIuYWRkQnV0dG9uKHtcbiAgICBpY29uOiAnZGFzaGJvYXJkJyxcbiAgICBjYWxsYmFjazogJ251Y2xpZGUtaGVhbHRoOnRvZ2dsZScsXG4gICAgdG9vbHRpcDogJ1RvZ2dsZSBOdWNsaWRlIGhlYWx0aCBzdGF0cycsXG4gICAgcHJpb3JpdHk6IDkwMCxcbiAgfSk7XG4gIHN1YnNjcmlwdGlvbnMuYWRkKG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICB0b29sQmFyLnJlbW92ZUl0ZW1zKCk7XG4gIH0pKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnN1bWVHYWRnZXRzU2VydmljZShnYWRnZXRzQXBpOiBHYWRnZXRzU2VydmljZSk6IERpc3Bvc2FibGUge1xuICBpbnZhcmlhbnQocGFuZUl0ZW1TdGF0ZSQpO1xuICBnYWRnZXRzID0gZ2FkZ2V0c0FwaTtcbiAgY29uc3QgZ2FkZ2V0OiBHYWRnZXQgPSAoY3JlYXRlSGVhbHRoR2FkZ2V0KHBhbmVJdGVtU3RhdGUkKTogYW55KTtcbiAgcmV0dXJuIGdhZGdldHNBcGkucmVnaXN0ZXJHYWRnZXQoZ2FkZ2V0KTtcbn1cblxuZnVuY3Rpb24gZGlzcG9zZUFjdGl2ZUVkaXRvckRpc3Bvc2FibGVzKCk6IHZvaWQge1xuICAvLyBDbGVhciBvdXQgYW55IGV2ZW50cyAmIHRpbWluZyBkYXRhIGZyb20gcHJldmlvdXMgdGV4dCBlZGl0b3IuXG4gIGlmIChhY3RpdmVFZGl0b3JTdWJzY3JpcHRpb25zICE9IG51bGwpIHtcbiAgICBhY3RpdmVFZGl0b3JTdWJzY3JpcHRpb25zLmRpc3Bvc2UoKTtcbiAgICBhY3RpdmVFZGl0b3JTdWJzY3JpcHRpb25zID0gbnVsbDtcbiAgfVxufVxuXG5mdW5jdGlvbiB0aW1lQWN0aXZlRWRpdG9yS2V5cygpOiB2b2lkIHtcbiAgZGlzcG9zZUFjdGl2ZUVkaXRvckRpc3Bvc2FibGVzKCk7XG4gIGFjdGl2ZUVkaXRvclN1YnNjcmlwdGlvbnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuXG4gIC8vIElmIG9wdGlvbiBpcyBlbmFibGVkLCBzdGFydCB0aW1pbmcgbGF0ZW5jeSBvZiBrZXlzIG9uIHRoZSBuZXcgdGV4dCBlZGl0b3IuXG4gIGlmICghcGFuZUl0ZW0pIHtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBFbnN1cmUgdGhlIGVkaXRvciBpcyB2YWxpZCBhbmQgdGhlcmUgaXMgYSB2aWV3IHRvIGF0dGF0Y2ggdGhlIGtleXByZXNzIHRpbWluZyB0by5cbiAgY29uc3QgZWRpdG9yOiA/VGV4dEVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcbiAgaWYgKCFlZGl0b3IpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgdmlldyA9IGF0b20udmlld3MuZ2V0VmlldyhlZGl0b3IpO1xuICBpZiAoIXZpZXcpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBTdGFydCB0aGUgY2xvY2sgd2hlbiBhIGtleSBpcyBwcmVzc2VkLiBGdW5jdGlvbiBpcyBuYW1lZCBzbyBpdCBjYW4gYmUgZGlzcG9zZWQgd2VsbC5cbiAgY29uc3Qgc3RhcnRLZXlDbG9jayA9ICgpID0+IHtcbiAgICBpZiAoZWRpdG9yKSB7XG4gICAgICBrZXlFZGl0b3JJZCA9IGVkaXRvci5pZDtcbiAgICAgIGtleURvd25UaW1lID0gRGF0ZS5ub3coKTtcbiAgICB9XG4gIH07XG5cbiAgLy8gU3RvcCB0aGUgY2xvY2sgd2hlbiB0aGUgKHNhbWUpIGVkaXRvciBoYXMgY2hhbmdlZCBjb250ZW50LlxuICBjb25zdCBzdG9wS2V5Q2xvY2sgPSAoKSA9PiB7XG4gICAgaWYgKGVkaXRvciAmJiBlZGl0b3IuaWQgJiYga2V5RWRpdG9ySWQgPT09IGVkaXRvci5pZCAmJiBrZXlEb3duVGltZSkge1xuICAgICAga2V5TGF0ZW5jeSA9IERhdGUubm93KCkgLSBrZXlEb3duVGltZTtcbiAgICAgIC8vIFJlc2V0IHNvIHRoYXQgc3Vic2VxdWVudCBub24ta2V5LWluaXRpYXRlZCBidWZmZXIgdXBkYXRlcyBkb24ndCBwcm9kdWNlIHNpbGx5IGJpZyBudW1iZXJzLlxuICAgICAga2V5RG93blRpbWUgPSAwO1xuICAgIH1cbiAgfTtcblxuICAvLyBBZGQgdGhlIGxpc3RlbmVyIHRvIGtleWRvd24uXG4gIHZpZXcuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHN0YXJ0S2V5Q2xvY2spO1xuXG4gIGFjdGl2ZUVkaXRvclN1YnNjcmlwdGlvbnMuYWRkKFxuICAgIC8vIFJlbW92ZSB0aGUgbGlzdGVuZXIgaW4gYSBob21lLW1hZGUgZGlzcG9zYWJsZSBmb3Igd2hlbiB0aGlzIGVkaXRvciBpcyBuby1sb25nZXIgYWN0aXZlLlxuICAgIG5ldyBEaXNwb3NhYmxlKCgpID0+IHZpZXcucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHN0YXJ0S2V5Q2xvY2spKSxcblxuICAgIC8vIHN0b3BLZXlDbG9jayBpcyBmYXN0IHNvIGF0dGF0Y2hpbmcgaXQgdG8gb25EaWRDaGFuZ2UgaGVyZSBpcyBPSy5cbiAgICAvLyBvbkRpZFN0b3BDaGFuZ2luZyB3b3VsZCBiZSBhbm90aGVyIG9wdGlvbiAtIGFueSBjb3N0IGlzIGRlZmVycmVkLCBidXQgd2l0aCBmYXIgbGVzcyBmaWRlbGl0eS5cbiAgICBlZGl0b3Iub25EaWRDaGFuZ2Uoc3RvcEtleUNsb2NrKSxcbiAgKTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlVmlld3MoKTogdm9pZCB7XG4gIGlmICghcGFuZUl0ZW1TdGF0ZSQpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBzdGF0cyA9IGdldEhlYWx0aFN0YXRzKCk7XG4gIGFuYWx5dGljc0J1ZmZlci5wdXNoKHN0YXRzKTtcbiAgcGFuZUl0ZW1TdGF0ZSQub25OZXh0KHtzdGF0cywgYWN0aXZlSGFuZGxlT2JqZWN0czogZ2V0QWN0aXZlSGFuZGxlcygpfSk7XG4gIGlmIChjdXJyZW50Q29uZmlnLnZpZXdUaW1lb3V0KSB7XG4gICAgaWYgKHZpZXdUaW1lb3V0ICE9PSBudWxsKSB7XG4gICAgICBjbGVhclRpbWVvdXQodmlld1RpbWVvdXQpO1xuICAgIH1cbiAgICB2aWV3VGltZW91dCA9IHNldFRpbWVvdXQodXBkYXRlVmlld3MsIGN1cnJlbnRDb25maWcudmlld1RpbWVvdXQgKiAxMDAwKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB1cGRhdGVBbmFseXRpY3MoKTogdm9pZCB7XG4gIGlmIChhbmFseXRpY3NCdWZmZXIubGVuZ3RoID4gMCkge1xuICAgIC8vIEFnZ3JlZ2F0ZXMgdGhlIGJ1ZmZlcmVkIHN0YXRzIHVwIGJ5IHN1ZmZpeGluZyBhdmcsIG1pbiwgbWF4IHRvIHRoZWlyIG5hbWVzLlxuICAgIGNvbnN0IGFnZ3JlZ2F0ZVN0YXRzID0ge307XG5cbiAgICAvLyBBbGwgYW5hbHl0aWNzQnVmZmVyIGVudHJpZXMgaGF2ZSB0aGUgc2FtZSBrZXlzOyB3ZSB1c2UgdGhlIGZpcnN0IGVudHJ5IHRvIGtub3cgd2hhdCB0aGV5IGFyZS5cbiAgICBPYmplY3Qua2V5cyhhbmFseXRpY3NCdWZmZXJbMF0pLmZvckVhY2goc3RhdHNLZXkgPT4ge1xuICAgICAgaWYgKHN0YXRzS2V5ID09PSAnbGFzdEtleUxhdGVuY3knKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgICAgLy8gVGhpcyBmaWVsZCBpcyBvbmx5IHVzZWQgdG8gZm9yIGEgc3RpY2t5IHZhbHVlIGluIHRoZSBzdGF0dXMgYmFyLCBhbmQgaXMgbm90IHRvIGJlIHNlbnQuXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGFnZ3JlZ2F0ZXMgPSBhZ2dyZWdhdGUoXG4gICAgICAgIGFuYWx5dGljc0J1ZmZlci5tYXAoc3RhdHMgPT4gc3RhdHNbc3RhdHNLZXldKSxcbiAgICAgICAgKHN0YXRzS2V5ID09PSAna2V5TGF0ZW5jeScpLCAvLyBza2lwWmVyb3M6IERvbid0IHVzZSBlbXB0eSBrZXkgbGF0ZW5jeSB2YWx1ZXMgaW4gYWdncmVnYXRlcy5cbiAgICAgICk7XG4gICAgICBPYmplY3Qua2V5cyhhZ2dyZWdhdGVzKS5mb3JFYWNoKGFnZ3JlZ2F0ZXNLZXkgPT4ge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IGFnZ3JlZ2F0ZXNbYWdncmVnYXRlc0tleV07XG4gICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgYWdncmVnYXRlU3RhdHNbYCR7c3RhdHNLZXl9XyR7YWdncmVnYXRlc0tleX1gXSA9IHZhbHVlLnRvRml4ZWQoMik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHRyYWNrKCdudWNsaWRlLWhlYWx0aCcsIGFnZ3JlZ2F0ZVN0YXRzKTtcbiAgICBhbmFseXRpY3NCdWZmZXIgPSBbXTtcbiAgfVxuXG4gIGlmIChjdXJyZW50Q29uZmlnLmFuYWx5dGljc1RpbWVvdXQpIHtcbiAgICBpZiAoYW5hbHl0aWNzVGltZW91dCAhPT0gbnVsbCkge1xuICAgICAgY2xlYXJUaW1lb3V0KGFuYWx5dGljc1RpbWVvdXQpO1xuICAgIH1cbiAgICBhbmFseXRpY3NUaW1lb3V0ID0gc2V0VGltZW91dCh1cGRhdGVBbmFseXRpY3MsIGN1cnJlbnRDb25maWcuYW5hbHl0aWNzVGltZW91dCAqIDYwICogMTAwMCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYWdncmVnYXRlKFxuICB2YWx1ZXM6IEFycmF5PG51bWJlcj4sXG4gIHNraXBaZXJvczogYm9vbGVhbiA9IGZhbHNlLFxuKToge2F2ZzogP251bWJlciwgbWluOiA/bnVtYmVyLCBtYXg6ID9udW1iZXJ9IHtcbiAgLy8gU29tZSB2YWx1ZXMgKGxpa2UgbWVtb3J5IHVzYWdlKSBtaWdodCBiZSB2ZXJ5IGhpZ2ggJiBudW1lcm91cywgc28gYXZvaWQgc3VtbWluZyB0aGVtIGFsbCB1cC5cbiAgaWYgKHNraXBaZXJvcykge1xuICAgIHZhbHVlcyA9IHZhbHVlcy5maWx0ZXIodmFsdWUgPT4gdmFsdWUgIT09IDApO1xuICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4ge2F2ZzogbnVsbCwgbWluOiBudWxsLCBtYXg6IG51bGx9O1xuICAgIH1cbiAgfVxuICBjb25zdCBhdmcgPSB2YWx1ZXMucmVkdWNlKChwcmV2VmFsdWUsIGN1cnJWYWx1ZSwgaW5kZXgpID0+IHtcbiAgICByZXR1cm4gcHJldlZhbHVlICsgKGN1cnJWYWx1ZSAtIHByZXZWYWx1ZSkgLyAoaW5kZXggKyAxKTtcbiAgfSwgMCk7XG4gIGNvbnN0IG1pbiA9IE1hdGgubWluKC4uLnZhbHVlcyk7XG4gIGNvbnN0IG1heCA9IE1hdGgubWF4KC4uLnZhbHVlcyk7XG4gIHJldHVybiB7YXZnLCBtaW4sIG1heH07XG59XG5cbmZ1bmN0aW9uIGdldEhlYWx0aFN0YXRzKCk6IEhlYWx0aFN0YXRzIHtcbiAgY29uc3Qgc3RhdHMgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJTUywgaGVhcCBhbmQgdXNhZ2UuXG5cbiAgaWYgKGtleUxhdGVuY3kpIHtcbiAgICBsYXN0S2V5TGF0ZW5jeSA9IGtleUxhdGVuY3k7XG4gIH1cblxuICBjb25zdCByZXN1bHQgPSB7XG4gICAgLi4uc3RhdHMsXG4gICAgaGVhcFBlcmNlbnRhZ2U6ICgxMDAgKiBzdGF0cy5oZWFwVXNlZCAvIHN0YXRzLmhlYXBUb3RhbCksICAgLy8gSnVzdCBmb3IgY29udmVuaWVuY2UuXG4gICAgY3B1UGVyY2VudGFnZTogb3MubG9hZGF2ZygpWzBdLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gMSBtaW51dGUgQ1BVIGF2ZXJhZ2UuXG4gICAgbGFzdEtleUxhdGVuY3ksXG4gICAga2V5TGF0ZW5jeSxcbiAgICBhY3RpdmVIYW5kbGVzOiBnZXRBY3RpdmVIYW5kbGVzKCkubGVuZ3RoLFxuICAgIGFjdGl2ZVJlcXVlc3RzOiBnZXRBY3RpdmVSZXF1ZXN0cygpLmxlbmd0aCxcbiAgfTtcblxuICBrZXlMYXRlbmN5ID0gMDsgLy8gV2Ugb25seSB3YW50IHRvIGV2ZXIgcmVjb3JkIGEga2V5IGxhdGVuY3kgdGltZSBvbmNlLCBhbmQgc28gd2UgcmVzZXQgaXQuXG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuLy8gVGhlc2UgdHdvIGZ1bmN0aW9ucyBhcmUgdG8gZGVmZW5kIGFnYWluc3QgdW5kb2N1bWVudGVkIE5vZGUgZnVuY3Rpb25zLlxuZnVuY3Rpb24gZ2V0QWN0aXZlSGFuZGxlcygpOiBBcnJheTxPYmplY3Q+IHtcbiAgaWYgKHByb2Nlc3MuX2dldEFjdGl2ZUhhbmRsZXMpIHtcbiAgICByZXR1cm4gcHJvY2Vzcy5fZ2V0QWN0aXZlSGFuZGxlcygpO1xuICB9XG4gIHJldHVybiBbXTtcbn1cblxuZnVuY3Rpb24gZ2V0QWN0aXZlUmVxdWVzdHMoKTogQXJyYXk8T2JqZWN0PiB7XG4gIGlmIChwcm9jZXNzLl9nZXRBY3RpdmVSZXF1ZXN0cykge1xuICAgIHJldHVybiBwcm9jZXNzLl9nZXRBY3RpdmVSZXF1ZXN0cygpO1xuICB9XG4gIHJldHVybiBbXTtcbn1cbiJdfQ==